<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#6366f1">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠÙ† - Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³ÙŠØ¯ Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --primary-light: #e0e7ff;
            --secondary: #8b5cf6;
            --success: #10b981;
            --success-light: #d1fae5;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark: #0f172a;
            --gray: #64748b;
            --gray-light: #f1f5f9;
            --light: #f8fafc;
            --white: #ffffff;
            --border: #e2e8f0;
        }

        body.dark-mode {
            --light: #0f172a;
            --white: #1e293b;
            --gray-light: #334155;
            --dark: #f1f5f9;
            --border: #475569;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--dark);
            direction: rtl;
            transition: all 0.3s ease;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            min-height: 100vh;
            background: var(--light);
        }

        /* Header */
        .app-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            padding: 1rem;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.08);
        }

        body.dark-mode .app-header {
            background: rgba(30, 41, 59, 0.95);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .app-title {
            font-size: 1.3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            color: white;
            padding: 0.5rem;
            border-radius: 12px;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            position: relative;
            margin-left: 0.5rem;
        }

        .notification-badge {
            position: absolute;
            top: -5px;
            left: -5px;
            background: var(--danger);
            color: white;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 0.15rem 0.4rem;
            border-radius: 10px;
        }

        /* Sidebar */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar {
            position: fixed;
            top: 0;
            right: -320px;
            width: 320px;
            height: 100vh;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            box-shadow: -4px 0 30px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            transition: right 0.3s ease;
            overflow-y: auto;
        }

        body.dark-mode .sidebar {
            background: rgba(30, 41, 59, 0.98);
        }

        .sidebar.active {
            right: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 2px solid var(--border);
            background: linear-gradient(135deg, var(--primary-light), rgba(139, 92, 246, 0.1));
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-close {
            background: var(--white);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sidebar-menu-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            border: none;
            width: 100%;
            text-align: right;
            color: var(--dark);
        }

        .sidebar-menu-item:hover {
            background: var(--primary-light);
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            margin-bottom: 0.5rem;
        }

        .toggle-switch {
            position: relative;
            width: 50px;
            height: 26px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--gray);
            transition: 0.3s;
            border-radius: 26px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        input:checked + .toggle-slider:before {
            transform: translateX(24px);
        }

        /* Main Content */
        .main-content {
            padding: 1.2rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .search-input {
            width: 100%;
            padding: 0.9rem 1.1rem 0.9rem 3.2rem;
            border: 2px solid var(--border);
            border-radius: 1.2rem;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        body.dark-mode .search-input {
            background: var(--white);
        }

        .cases-grid {
            display: grid;
            gap: 1.2rem;
            grid-template-columns: 1fr;
            margin-top: 1.2rem;
        }

        @media (min-width: 768px) {
            .cases-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .cases-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .case-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 1.2rem;
            padding: 1.4rem;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.06);
            transition: all 0.4s ease;
            cursor: pointer;
        }

        body.dark-mode .case-card {
            background: rgba(30, 41, 59, 0.95);
        }

        .case-card:hover {
            transform: translateY(-6px);
            box-shadow: 0 16px 50px rgba(99, 102, 241, 0.15);
        }

        .case-number {
            background: linear-gradient(135deg, var(--primary-light), rgba(139, 92, 246, 0.1));
            color: var(--primary);
            padding: 0.4rem 0.8rem;
            border-radius: 0.8rem;
            font-size: 0.85rem;
            font-weight: 700;
            display: inline-block;
        }

        .case-status {
            padding: 0.4rem 0.8rem;
            border-radius: 1.2rem;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .status-Ø¬Ø¯ÙŠØ¯Ø© { background: linear-gradient(135deg, #dbeafe, #bfdbfe); color: #1e40af; }
        .status-Ù‚ÙŠØ¯-Ø§Ù„Ù†Ø¸Ø± { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #92400e; }
        .status-Ù…Ø±Ø§Ø¬Ø¹Ø© { background: linear-gradient(135deg, #ede9fe, #ddd6fe); color: #6b21a8; }
        .status-Ù…Ø±Ø§ÙØ¹Ø© { background: linear-gradient(135deg, #fed7aa, #fdba74); color: #9a3412; }
        .status-Ø­ÙƒÙ… { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #3730a3; }
        .status-ØªÙ†ÙÙŠØ° { background: linear-gradient(135deg, #d1fae5, #a7f3d0); color: #065f46; }
        .status-Ù…ØºÙ„Ù‚Ø© { background: linear-gradient(135deg, #f3f4f6, #e5e7eb); color: #374151; }

        .btn {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border: none;
            padding: 0.9rem 1.5rem;
            border-radius: 1rem;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            width: 100%;
        }

        .btn:hover {
            transform: translateY(-3px);
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 1.5rem;
            max-width: 480px;
            width: 100%;
            max-height: 85vh;
            overflow-y: auto;
        }

        body.dark-mode .modal {
            background: rgba(30, 41, 59, 0.98);
        }

        .form-control {
            width: 100%;
            padding: 0.9rem;
            border: 2px solid var(--border);
            border-radius: 1rem;
            font-size: 1rem;
        }

        .hidden {
            display: none !important;
        }

        .fab {
            position: fixed;
            bottom: 1.5rem;
            left: 1.5rem;
            background: linear-gradient(135deg, var(--success), #059669);
            color: white;
            border: none;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 30px rgba(16, 185, 129, 0.4);
            z-index: 50;
        }

        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
        }

        .login-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 2rem;
            padding: 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>

<body>
    <div class="app-container">
        <!-- Login Screen -->
        <div id="login-screen" class="login-screen">
            <div class="login-card">
                <div style="text-align: center; margin-bottom: 2rem;">
                    <i class="fas fa-balance-scale" style="font-size: 4rem; color: var(--primary);"></i>
                    <h1 style="margin: 1rem 0 0.5rem;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠÙ†</h1>
                    <p style="color: var(--gray);">Ù…Ø¬Ù…ÙˆØ¹Ø© Ø§Ù„Ø³ÙŠØ¯ Ø£Ø³Ø§Ù…Ø© Ø§Ù„Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©</p>
                </div>
                
                <form id="login-form">
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.6rem; font-weight: 700;">Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ</label>
                        <input type="text" id="license-number" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„ØªØ±Ø®ÙŠØµ" required>
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <label style="display: block; margin-bottom: 0.6rem; font-weight: 700;">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</label>
                        <input type="tel" id="phone-number" class="form-control" placeholder="Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ" required>
                    </div>
                    
                    <button type="submit" class="btn" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i>
                        ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                    </button>
                </form>
            </div>
        </div>

        <!-- Main App -->
        <div id="main-app" class="hidden">
            <!-- Sidebar -->
            <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h3 style="font-weight: 800;">Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</h3>
                    <button class="sidebar-close" onclick="closeSidebar()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>

                <div style="padding: 1rem;">
                    <button class="sidebar-menu-item" onclick="refreshData(); closeSidebar();">
                        <i class="fas fa-sync-alt"></i>
                        <span>ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</span>
                    </button>
                    <button class="sidebar-menu-item" onclick="showAddDeductionModal(); closeSidebar();">
                        <i class="fas fa-plus-circle"></i>
                        <span>Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</span>
                    </button>
                    <button class="sidebar-menu-item" onclick="logout(); closeSidebar();">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                    </button>
                </div>

                <div style="padding: 1rem; border-top: 1px solid var(--border);">
                    <div class="setting-item">
                        <span><i class="fas fa-moon"></i> Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="dark-mode-toggle" onchange="toggleDarkMode()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <div class="setting-item">
                        <span><i class="fas fa-bell"></i> Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</span>
                        <label class="toggle-switch">
                            <input type="checkbox" id="notifications-toggle" checked>
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Header -->
            <div class="app-header">
                <div class="header-content">
                    <div class="app-title">
                        <i class="fas fa-balance-scale"></i>
                        ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ù…Ø­Ø§Ù…ÙŠÙ†
                    </div>
                    <div style="display: flex;">
                        <button class="header-btn" onclick="toggleSidebar()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div style="background: var(--gray-light); padding: 0.6rem 1rem; font-size: 0.875rem;">
                <span id="connection-status">ØºÙŠØ± Ù…ØªØµÙ„</span>
                <span id="lawyer-info" style="float: left; background: var(--primary-light); padding: 0.4rem 0.9rem; border-radius: 20px;"></span>
            </div>

            <!-- Main Content -->
            <div class="main-content">
                <div style="position: relative; margin-bottom: 1.2rem;">
                    <input type="text" class="search-input" id="search-input" placeholder="Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ø¯Ø¹Ø§ÙˆÙ‰..." onkeyup="searchCases()">
                    <i class="fas fa-search" style="position: absolute; right: 1.1rem; top: 50%; transform: translateY(-50%); color: var(--primary);"></i>
                </div>

                <div id="loading" class="hidden" style="text-align: center; padding: 3rem;">
                    <div style="width: 2.5rem; height: 2.5rem; border: 3px solid var(--border); border-top: 3px solid var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto;"></div>
                </div>

                <div id="cases-container" class="cases-grid"></div>

                <div id="empty-state" class="hidden" style="text-align: center; padding: 3rem; color: var(--gray);">
                    <i class="fas fa-folder-open" style="font-size: 4rem; margin-bottom: 1.2rem;"></i>
                    <h3>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯Ø¹Ø§ÙˆÙ‰</h3>
                </div>
            </div>

            <button class="fab" onclick="showAddDeductionModal()">
                <i class="fas fa-plus"></i>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <div id="case-details-modal" class="modal-overlay">
        <div class="modal">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3 id="case-details-title">ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¯Ø¹ÙˆÙ‰</h3>
                <button onclick="closeModal('case-details-modal')" style="float: left; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
            <div id="case-details-body" style="padding: 1.5rem;"></div>
        </div>
    </div>

    <div id="update-status-modal" class="modal-overlay">
        <div class="modal">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3>ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆÙ‰</h3>
                <button onclick="closeModal('update-status-modal')" style="float: left; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</label>
                    <select id="new-status" class="form-control">
                        <option value="Ø¬Ø¯ÙŠØ¯Ø©">Ø¬Ø¯ÙŠØ¯Ø©</option>
                        <option value="Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø¸Ø±">Ù‚ÙŠØ¯ Ø§Ù„Ù†Ø¸Ø±</option>
                        <option value="Ù…Ø±Ø§Ø¬Ø¹Ø©">Ù…Ø±Ø§Ø¬Ø¹Ø©</option>
                        <option value="Ù…Ø±Ø§ÙØ¹Ø©">Ù…Ø±Ø§ÙØ¹Ø©</option>
                        <option value="Ø­ÙƒÙ…">Ø­ÙƒÙ…</option>
                        <option value="ØªÙ†ÙÙŠØ°">ØªÙ†ÙÙŠØ°</option>
                        <option value="Ù…ØºÙ„Ù‚Ø©">Ù…ØºÙ„Ù‚Ø©</option>
                    </select>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="status-notes" class="form-control" rows="3"></textarea>
                </div>
                <button class="btn" onclick="updateCaseStatus()">ØªØ­Ø¯ÙŠØ«</button>
            </div>
        </div>
    </div>

    <div id="add-deduction-modal" class="modal-overlay">
        <div class="modal">
            <div style="padding: 1.5rem; border-bottom: 1px solid var(--border);">
                <h3>Ø¥Ø¶Ø§ÙØ© Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø¬Ø¯ÙŠØ¯</h3>
                <button onclick="closeModal('add-deduction-modal')" style="float: left; background: none; border: none; font-size: 1.5rem; cursor: pointer;">Ã—</button>
            </div>
            <div style="padding: 1.5rem;">
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø¹ÙˆÙ‰</label>
                    <select id="deduction-case" class="form-control">
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø¹ÙˆÙ‰...</option>
                    </select>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø³ØªÙ‚Ø·Ø¹ (Ø¯.Ø¹)</label>
                    <input type="number" id="deduction-amount" class="form-control" min="0">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</label>
                    <input type="date" id="deduction-date" class="form-control">
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ø§Ù„Ù…ØµØ¯Ø±</label>
                    <select id="deduction-source" class="form-control">
                        <option value="Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø¨Ø¯Ø§Ø¡Ø©">Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø¨Ø¯Ø§Ø¡Ø©</option>
                        <option value="Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°">Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„ØªÙ†ÙÙŠØ°</option>
                        <option value="Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù">Ù…Ø­ÙƒÙ…Ø© Ø§Ù„Ø§Ø³ØªØ¦Ù†Ø§Ù</option>
                        <option value="Ù…Ø­ÙƒÙ…Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ²">Ù…Ø­ÙƒÙ…Ø© Ø§Ù„ØªÙ…ÙŠÙŠØ²</option>
                    </select>
                </div>
                <div style="margin-bottom: 1.5rem;">
                    <label style="display: block; margin-bottom: 0.6rem;">Ù…Ù„Ø§Ø­Ø¸Ø§Øª</label>
                    <textarea id="deduction-notes" class="form-control" rows="3"></textarea>
                </div>
                <button class="btn" onclick="addDeduction()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹</button>
            </div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDrZmZwSOVhonbLWGrHnctkV4tUcT7UNZM",
            authDomain: "legal-department-dbd28.firebaseapp.com",
            databaseURL: "https://legal-department-dbd28-default-rtdb.firebaseio.com",
            projectId: "legal-department-dbd28",
            storageBucket: "legal-department-dbd28.firebasestorage.app",
            messagingSenderId: "452600951683",
            appId: "1:452600951683:web:2929d22d53a309d947fcb6"
        };

        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        let currentLawyer = null;
        let allCases = [];
        let filteredCases = [];
        let selectedCaseId = null;
        let isConnected = false;

        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            setupConnectionMonitoring();
            setupFormHandlers();
            loadSettings();
        });

        function setupFormHandlers() {
            document.getElementById('login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                login();
            });
            document.getElementById('deduction-date').value = new Date().toISOString().split('T')[0];
        }

        function loadSettings() {
            const darkMode = localStorage.getItem('darkMode') === 'true';
            document.getElementById('dark-mode-toggle').checked = darkMode;
            if (darkMode) {
                document.body.classList.add('dark-mode');
            }
        }

        function toggleDarkMode() {
            const isDark = document.getElementById('dark-mode-toggle').checked;
            document.body.classList.toggle('dark-mode', isDark);
            localStorage.setItem('darkMode', isDark);
            alert(isDark ? 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ' : 'ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù†Ù‡Ø§Ø±ÙŠ');
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
            document.getElementById('sidebar-overlay').classList.toggle('active');
        }

        function closeSidebar() {
            document.getElementById('sidebar').classList.remove('active');
            document.getElementById('sidebar-overlay').classList.remove('active');
        }

        function setupConnectionMonitoring() {
            const connectedRef = database.ref('.info/connected');
            connectedRef.on('value', (snapshot) => {
                isConnected = snapshot.val() === true;
                updateConnectionStatus();
                if (isConnected && currentLawyer) {
                    loadLawyerCases();
                }
            });

            database.ref('system/lastUpdate').on('value', (snapshot) => {
                if (currentLawyer) {
                    loadLawyerCases();
                }
            });
        }

        function updateConnectionStatus() {
            const statusEl = document.getElementById('connection-status');
            if (isConnected && navigator.onLine) {
                statusEl.textContent = 'Ù…ØªØµÙ„ Ø¨Ù€ Firebase';
                statusEl.style.color = 'var(--success)';
            } else {
                statusEl.textContent = 'ØºÙŠØ± Ù…ØªØµÙ„';
                statusEl.style.color = 'var(--danger)';
            }
        }

        function checkLoginStatus() {
            const savedLawyer = localStorage.getItem('currentLawyer');
            if (savedLawyer) {
                currentLawyer = JSON.parse(savedLawyer);
                showMainApp();
                updateLawyerInfo();
                loadLawyerCases();
            } else {
                showLoginScreen();
            }
        }

        async function login() {
            const licenseNumber = document.getElementById('license-number').value.trim();
            const phoneNumber = document.getElementById('phone-number').value.trim();
            const loginBtn = document.getElementById('login-btn');

            if (!licenseNumber || !phoneNumber) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';

            try {
                let lawyersSnapshot = await database.ref('data/lawyers').once('value');
                let lawyers = lawyersSnapshot.val();
                
                if (!lawyers) {
                    lawyersSnapshot = await database.ref('lawyers').once('value');
                    lawyers = lawyersSnapshot.val();
                }

                let foundLawyer = null;
                if (lawyers) {
                    if (Array.isArray(lawyers)) {
                        lawyers.forEach(lawyer => {
                            if (lawyer && lawyer.license === licenseNumber && lawyer.phone === phoneNumber) {
                                foundLawyer = lawyer;
                            }
                        });
                    } else {
                        Object.values(lawyers).forEach(lawyer => {
                            if (lawyer && lawyer.license === licenseNumber && lawyer.phone === phoneNumber) {
                                foundLawyer = lawyer;
                            }
                        });
                    }
                }

                if (foundLawyer) {
                    currentLawyer = foundLawyer;
                    localStorage.setItem('currentLawyer', JSON.stringify(foundLawyer));
                    
                    updateLawyerInfo();
                    showMainApp();
                    loadLawyerCases();
                    alert(`Ù…Ø±Ø­Ø¨Ø§Ù‹ ${foundLawyer.name}`);
                } else {
                    alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„');
            }

            loginBtn.disabled = false;
            loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';
        }

        function logout() {
            localStorage.removeItem('currentLawyer');
            currentLawyer = null;
            allCases = [];
            filteredCases = [];
            showLoginScreen();
            alert('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­');
        }

        function showLoginScreen() {
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('main-app').classList.add('hidden');
        }

        function showMainApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('main-app').classList.remove('hidden');
        }

        function updateLawyerInfo() {
            if (currentLawyer) {
                document.getElementById('lawyer-info').textContent = `Ø§Ù„Ù…Ø­Ø§Ù…ÙŠ: ${currentLawyer.name}`;
            }
        }

        async function loadLawyerCases() {
            if (!currentLawyer || !isConnected) return;

            document.getElementById('loading').classList.remove('hidden');

            try {
                let casesSnapshot = await database.ref('data/cases').once('value');
                let cases = casesSnapshot.val();
                
                if (!cases) {
                    casesSnapshot = await database.ref('cases').once('value');
                    cases = casesSnapshot.val();
                }

                allCases = [];
                
                if (cases) {
                    if (Array.isArray(cases)) {
                        cases.forEach(caseItem => {
                            if (caseItem && caseItem.lawyerName === currentLawyer.name) {
                                allCases.push(caseItem);
                            }
                        });
                    } else {
                        Object.entries(cases).forEach(([caseId, caseItem]) => {
                            if (caseItem && caseItem.lawyerName === currentLawyer.name) {
                                caseItem.firebaseId = caseId;
                                if (!caseItem.id) caseItem.id = caseId;
                                allCases.push(caseItem);
                            }
                        });
                    }
                }
                
                filteredCases = [...allCases];
                renderCases();
                populateCaseSelector();
                document.getElementById('loading').classList.add('hidden');
            } catch (error) {
                console.error('Error loading cases:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¯Ø¹Ø§ÙˆÙ‰');
                document.getElementById('loading').classList.add('hidden');
            }
        }

        function renderCases() {
            const container = document.getElementById('cases-container');
            const emptyState = document.getElementById('empty-state');

            if (filteredCases.length === 0) {
                container.classList.add('hidden');
                emptyState.classList.remove('hidden');
                return;
            }

            container.classList.remove('hidden');
            emptyState.classList.add('hidden');

            container.innerHTML = filteredCases.map(caseItem => {
                const caseId = caseItem.id || caseItem.firebaseId || caseItem.caseNumber;
                return `
                <div class="case-card" onclick="showCaseDetails('${caseId}')">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                        <span class="case-number">${caseItem.caseNumber}</span>
                        <span class="case-status status-${caseItem.status.replace(/\s+/g, '-')}">${caseItem.status}</span>
                    </div>
                    <h3 style="font-size: 1.05rem; font-weight: 800; margin-bottom: 0.9rem;">${caseItem.subject}</h3>
                    <div style="margin-bottom: 1rem; color: var(--gray); font-size: 0.875rem;">
                        <div style="margin-bottom: 0.6rem;"><i class="fas fa-user"></i> Ø§Ù„Ù…Ø¯Ø¹ÙŠ: ${caseItem.plaintiffName}</div>
                        <div style="margin-bottom: 0.6rem;"><i class="fas fa-user-tie"></i> Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡: ${caseItem.defendantName}</div>
                        <div><i class="fas fa-calendar"></i> Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${formatDate(caseItem.fileDate)}</div>
                    </div>
                    <div style="background: linear-gradient(135deg, var(--success-light), rgba(16, 185, 129, 0.1)); color: var(--success); padding: 0.8rem; border-radius: 0.9rem; text-align: center; font-weight: 900; font-size: 1.3rem; margin-bottom: 1rem;">
                        ${formatNumber(caseItem.amount)} Ø¯.Ø¹
                    </div>
                    ${caseItem.deductions > 0 ? `
                    <div style="background: linear-gradient(135deg, var(--success-light), rgba(16, 185, 129, 0.1)); color: var(--success); padding: 0.7rem; border-radius: 0.9rem; text-align: center; font-weight: 700; font-size: 0.9rem; margin-bottom: 1rem;">
                        ğŸ’° Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª: ${formatNumber(caseItem.deductions)} Ø¯.Ø¹
                    </div>
                    ` : ''}
                    <div style="display: flex; gap: 0.6rem;">
                        <button style="flex: 1; background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; border: none; padding: 0.6rem; border-radius: 0.9rem; cursor: pointer; font-size: 0.85rem;" onclick="event.stopPropagation(); showUpdateStatusModal('${caseId}')">
                            <i class="fas fa-edit"></i> ØªØ­Ø¯ÙŠØ«
                        </button>
                        <button style="flex: 1; background: linear-gradient(135deg, var(--success), #059669); color: white; border: none; padding: 0.6rem; border-radius: 0.9rem; cursor: pointer; font-size: 0.85rem;" onclick="event.stopPropagation(); showAddDeductionModal('${caseId}')">
                            <i class="fas fa-plus"></i> Ø§Ø³ØªÙ‚Ø·Ø§Ø¹
                        </button>
                    </div>
                </div>
                `;
            }).join('');
        }

        function searchCases() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            
            if (!searchTerm) {
                filteredCases = [...allCases];
            } else {
                filteredCases = allCases.filter(caseItem => 
                    caseItem.caseNumber.toLowerCase().includes(searchTerm) ||
                    caseItem.subject.toLowerCase().includes(searchTerm) ||
                    caseItem.plaintiffName.toLowerCase().includes(searchTerm) ||
                    caseItem.defendantName.toLowerCase().includes(searchTerm)
                );
            }
            
            renderCases();
        }

        function refreshData() {
            loadLawyerCases().then(() => {
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
            });
        }

        function showCaseDetails(caseId) {
            let caseItem = allCases.find(c => (c.id && c.id.toString() === caseId.toString()) || (c.firebaseId && c.firebaseId.toString() === caseId.toString()) || c.caseNumber === caseId);
            if (!caseItem) return;

            document.getElementById('case-details-title').textContent = `Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø±Ù‚Ù… ${caseItem.caseNumber}`;
            document.getElementById('case-details-body').innerHTML = `
                <div style="padding: 0.9rem 0; border-bottom: 1px solid var(--border);">
                    <strong>Ø§Ù„Ù…ÙˆØ¶ÙˆØ¹:</strong> ${caseItem.subject}
                </div>
                <div style="padding: 0.9rem 0; border-bottom: 1px solid var(--border);">
                    <strong>Ø§Ù„Ù…Ø¯Ø¹ÙŠ:</strong> ${caseItem.plaintiffName}
                </div>
                <div style="padding: 0.9rem 0; border-bottom: 1px solid var(--border);">
                    <strong>Ø§Ù„Ù…Ø¯Ø¹Ù‰ Ø¹Ù„ÙŠÙ‡:</strong> ${caseItem.defendantName}
                </div>
                <div style="padding: 0.9rem 0; border-bottom: 1px solid var(--border);">
                    <strong>Ø§Ù„Ù…Ø¨Ù„Øº:</strong> ${formatNumber(caseItem.amount)} Ø¯.Ø¹
                </div>
                <div style="padding: 0.9rem 0; border-bottom: 1px solid var(--border);">
                    <strong>Ø§Ù„Ù…Ø­ÙƒÙ…Ø©:</strong> ${caseItem.courtName}
                </div>
                ${caseItem.deductions > 0 ? `
                <div style="padding: 0.9rem 0;">
                    <strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹Ø§Øª:</strong> ${formatNumber(caseItem.deductions)} Ø¯.Ø¹
                </div>
                ` : ''}
            `;

            document.getElementById('case-details-modal').classList.add('active');
        }

        function showUpdateStatusModal(caseId) {
            selectedCaseId = caseId;
            let caseItem = allCases.find(c => (c.id && c.id.toString() === caseId.toString()) || (c.firebaseId && c.firebaseId.toString() === caseId.toString()) || c.caseNumber === caseId);
            if (!caseItem) return;

            document.getElementById('new-status').value = caseItem.status;
            document.getElementById('status-notes').value = '';
            document.getElementById('update-status-modal').classList.add('active');
        }

        async function updateCaseStatus() {
            if (!selectedCaseId) return;

            const newStatus = document.getElementById('new-status').value;
            const notes = document.getElementById('status-notes').value.trim();

            if (!newStatus) {
                alert('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
                return;
            }

            try {
                let caseItem = allCases.find(c => (c.id && c.id.toString() === selectedCaseId.toString()) || (c.firebaseId && c.firebaseId.toString() === selectedCaseId.toString()) || c.caseNumber === selectedCaseId);
                const actualCaseId = caseItem ? (caseItem.firebaseId || caseItem.id || caseItem.caseNumber) : selectedCaseId;

                const updateData = {
                    status: newStatus,
                    lastModified: new Date().toISOString()
                };

                if (notes && caseItem) {
                    if (!caseItem.timeline) caseItem.timeline = [];
                    caseItem.timeline.push({
                        date: new Date().toISOString().split('T')[0],
                        title: `ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰: ${newStatus}`,
                        desc: notes,
                        type: 'blue'
                    });
                    updateData.timeline = caseItem.timeline;
                    updateData.notes = notes;
                }

                try {
                    const casesSnapshot = await database.ref('data/cases').once('value');
                    const cases = casesSnapshot.val();
                    if (Array.isArray(cases)) {
                        const caseIndex = cases.findIndex(c => c.id === actualCaseId || c.caseNumber === actualCaseId);
                        if (caseIndex >= 0) {
                            await database.ref(`data/cases/${caseIndex}`).update(updateData);
                        }
                    }
                } catch (e) {
                    try {
                        await database.ref(`cases/${actualCaseId}`).update(updateData);
                    } catch (e2) {}
                }

                if (caseItem) {
                    Object.assign(caseItem, updateData);
                    filteredCases = [...allCases];
                    renderCases();
                }

                closeModal('update-status-modal');
                alert('ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø¨Ù†Ø¬Ø§Ø­');
            } catch (error) {
                console.error('Error updating case status:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø¹ÙˆÙ‰');
            }
        }

        function populateCaseSelector() {
            const selector = document.getElementById('deduction-case');
            selector.innerHTML = '<option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯Ø¹ÙˆÙ‰...</option>';
            
            allCases.forEach(caseItem => {
                const caseId = caseItem.id || caseItem.firebaseId || caseItem.caseNumber;
                selector.innerHTML += `<option value="${caseId}">${caseItem.caseNumber} - ${caseItem.plaintiffName}</option>`;
            });
        }

        function showAddDeductionModal(preSelectedCaseId = null) {
            populateCaseSelector();
            
            if (preSelectedCaseId) {
                document.getElementById('deduction-case').value = preSelectedCaseId;
            } else {
                document.getElementById('deduction-case').value = '';
            }
            
            document.getElementById('deduction-amount').value = '';
            document.getElementById('deduction-notes').value = '';
            document.getElementById('add-deduction-modal').classList.add('active');
        }

        async function addDeduction() {
            const caseId = document.getElementById('deduction-case').value;
            const amount = parseInt(document.getElementById('deduction-amount').value);
            const date = document.getElementById('deduction-date').value;
            const source = document.getElementById('deduction-source').value;
            const notes = document.getElementById('deduction-notes').value.trim();

            if (!caseId || !amount || !date || !source) {
                alert('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©');
                return;
            }

            if (amount <= 0) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­');
                return;
            }

            let selectedCase = allCases.find(c => (c.id && c.id.toString() === caseId.toString()) || (c.firebaseId && c.firebaseId.toString() === caseId.toString()) || c.caseNumber === caseId);

            if (!selectedCase) {
                alert('Ø§Ù„Ø¯Ø¹ÙˆÙ‰ Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
                return;
            }

            try {
                const deductionId = Date.now().toString() + Math.random().toString(36).substr(2, 9);
                const actualCaseId = selectedCase.firebaseId || selectedCase.id || selectedCase.caseNumber;
                
                const deductionData = {
                    id: deductionId,
                    caseId: actualCaseId,
                    caseNumber: selectedCase.caseNumber,
                    plaintiffName: selectedCase.plaintiffName,
                    amount: amount,
                    date: date,
                    source: source,
                    status: 'Ù…Ø³ØªÙ„Ù…',
                    notes: notes || '',
                    lawyerName: currentLawyer.name,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString(),
                    addedVia: 'mobile_app'
                };

                await database.ref(`data/deductions/${deductionId}`).set(deductionData);
                await database.ref(`deductions/${deductionId}`).set(deductionData);

                const updatedDeductions = (selectedCase.deductions || 0) + amount;
                const updateData = {
                    deductions: updatedDeductions,
                    lastModified: new Date().toISOString()
                };

                if (!selectedCase.timeline) selectedCase.timeline = [];
                selectedCase.timeline.push({
                    date: date,
                    title: 'Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø¬Ø¯ÙŠØ¯',
                    desc: `ØªÙ… Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ ${formatNumber(amount)} Ø¯.Ø¹ Ù…Ù† ${source}${notes ? ` - ${notes}` : ''}`,
                    type: 'green'
                });
                updateData.timeline = selectedCase.timeline;

                try {
                    await database.ref(`cases/${actualCaseId}`).update(updateData);
                } catch (e) {
                    const casesSnapshot = await database.ref('data/cases').once('value');
                    const cases = casesSnapshot.val();
                    
                    if (cases && Array.isArray(cases)) {
                        const caseIndex = cases.findIndex(c => c.id === actualCaseId || c.caseNumber === actualCaseId);
                        if (caseIndex >= 0) {
                            await database.ref(`data/cases/${caseIndex}`).update(updateData);
                        }
                    }
                }

                selectedCase.deductions = updatedDeductions;
                selectedCase.lastModified = new Date().toISOString();
                selectedCase.timeline = updateData.timeline;

                await database.ref('system/lastUpdate').set({
                    timestamp: new Date().toISOString(),
                    source: 'mobile_app',
                    action: 'deduction_added',
                    lawyerName: currentLawyer.name
                });

                renderCases();
                closeModal('add-deduction-modal');
                alert(`ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹ Ø¨Ù†Ø¬Ø§Ø­ - ${formatNumber(amount)} Ø¯.Ø¹`);
                
                setTimeout(() => {
                    loadLawyerCases();
                }, 1000);
                
            } catch (error) {
                console.error('Error adding deduction:', error);
                alert('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø§Ø³ØªÙ‚Ø·Ø§Ø¹');
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            selectedCaseId = null;
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('ar-IQ').format(number);
        }

        function formatDate(dateString) {
            if (!dateString) return '-';
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-IQ');
        }

        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal-overlay')) {
                e.target.classList.remove('active');
            }
        });

        setInterval(() => {
            if (currentLawyer && isConnected) {
                loadLawyerCases();
            }
        }, 5 * 60 * 1000);
    </script>
</body>
</html>
